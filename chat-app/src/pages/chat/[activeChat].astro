---
import WCAGChatPage from "@/components/chat-ui/WCAGChatPage";
import AuthedChatLayout from "@/layouts/AuthedChatLayout.astro";
import { supabaseServerClient } from "@/lib/supabase";
import { actions } from "astro:actions";

const supabaseBE = supabaseServerClient({
	request: Astro.request,
	cookies: Astro.cookies,
});

const {
	data: { user },
} = await supabaseBE.auth.getUser();

const activeUser = user;
const { activeChat } = Astro.params;

const chatResult = await Astro.callAction(actions.getChat, {
	chatId: activeChat!,
});

const { data } = chatResult;

if (!data?.success || typeof data.message === "string") {
	return Astro.redirect("/chat");
}

const { data: chatMessages } = await Astro.callAction(actions.readChatMsgs, {
	activeChatId: activeChat as string,
});

const messages = Array.isArray(chatMessages?.message)
	? chatMessages.message
	: [];
---

<AuthedChatLayout>
	<WCAGChatPage
		client:load
		user={activeUser}
		initialMessages={messages}
		activeChatId={activeChat}
	/>
</AuthedChatLayout>
